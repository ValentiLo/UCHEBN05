Отлично, это ключевой практический этап. Вот подробное руководство по установке и настройке системы контроля версий с разграничением ролей для проекта интернет-магазина.

---

### **УП05. Установка и настройка системы контроля версий с разграничением ролей**

#### **1. Выбор и обоснование выбора системы контроля версий**

**Выбор:** **Git**

**Обоснование:**
*   **Распределенность:** Каждый разработчик имеет полную локальную копию истории репозитория, что позволяет работать офлайн и обеспечивает отказоустойчивость.
*   **Производительность:** Операции (коммиты, просмотр истории, ветвление) выполняются локально и очень быстро.
*   **Ветвление и слияние:** Мощные и удобные механизмы ветвления, что критически важно для реализации функциональности, исправления ошибок и подготовки релизов.
*   **Экосистема:** Огромное сообщество, интеграция со всеми популярными инструментами разработки (IDE, CI/CD), а также с платформами для хостинга репозиториев (**GitLab**, **GitHub**, **Bitbucket**).

**Выбор хостинга репозиториев:** **GitLab Self-Hosted** (внутренний сервер)
*   **Обоснование:** Полный контроль над данными, возможность тонкой настройки политик безопасности, встроенный CI/CD, удобное управление доступом и код-ревью. Для коммерческого проекта с закрытым кодом это предпочтительный вариант.

---

#### **2. Установка и базовая настройка GitLab**

**Шаг 1: Установка GitLab на сервер (на примере Ubuntu 20.04+)**

```bash
# Обновление пакетов
sudo apt update && sudo apt upgrade -y

# Установка зависимостей
sudo apt install -y curl openssh-server ca-certificates tzdata perl

# Добавление официального репозитория GitLab
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash

# Установка GitLab (заменить YOUR_SERVER_URL на адрес вашего сервера, например, git.company.com)
sudo EXTERNAL_URL="https://YOUR_SERVER_URL" apt-get install gitlab-ee
```

**Шаг 2: Первоначальная настройка**

После установки откройте в браузере `https://YOUR_SERVER_URL`. Вам будет предложено задать пароль для пользователя `root`.

---

#### **3. Проектирование структуры репозитория и workflow**

**Модель ветвления:** **GitFlow** (или его упрощенная версия)

*   **`main`/`master`:** Стабильная ветка, готовый к развертыванию код. Соответствует продакшен-окружению.
*   **`develop`:** Ветка для интеграции новых функций. Соответствует staging-окружению.
*   **`feature/*`:** Ветки для разработки новой функциональности (например, `feature/payment-integration`). Создаются от `develop`, вливаются обратно в `develop`.
*   **`hotfix/*`:** Ветки для срочного исправления багов в `main` (например, `hotfix/critical-security-fix`). Создаются от `main`, вливаются в `main` и `develop`.
*   **`release/*`:** Ветки для подготовки релиза (тестирование, фиксация версий).

---

#### **4. Создание проекта и настройка репозитория**

1.  Войдите в GitLab под учетной записью `root`.
2.  Создайте новую группу (например, `ecommerce`).
3.  В группе создайте новый проект: `online-store-backend`.
4.  **Важно:** Инициализируйте репозиторий с `README.md`, чтобы сразу создать первую ветку.

**Перенос кода в репозиторий (с локальной машины разработчика):**

```bash
# В локальной папке с проектом
git init
git add .
git commit -m "Initial commit: Django project structure for online store"

# Добавляем удаленный репозиторий
git remote add origin https://YOUR_SERVER_URL/ecommerce/online-store-backend.git

# Пушим код в ветку main
git push -u origin main

# Создаем и пушим ветку develop
git checkout -b develop
git push -u origin develop
```

---

#### **5. Настройка разграничения ролей (Access Control)**

GitLab предоставляет гибкую систему разрешений на основе ролей.

**Шаг 1: Создание пользователей**
*   Администратор создает учетные записи для всех членов команды (или подключает LDAP/AD).
*   Пример пользователей: `alexey.dev`, `maria.qa`, `pavel.lead`.

**Шаг 2: Назначение ролей на уровне группы/проекта**

Роли в GitLab (от наивысших прав к наименьшим):

1.  **Owner (Владелец)** – Полный доступ к проекту, группе, настройкам.
2.  **Maintainer (Редактор)** – Может управлять репозиторием, ветками, тегами, настройками CI/CD, но не может удалить проект.
3.  **Developer (Разработчик)** – Может создавать ветки, пушить код, создавать/редактировать/принимать MR.
4.  **Reporter (Репортер)** – Только чтение, может создавать issues.
5.  **Guest (Гость)** – Очень ограниченный доступ.

**Пример матрицы ролей для проекта:**

| Роль в команде       | Роль в GitLab | Обоснование                                                                 |
| -------------------- | ------------- | --------------------------------------------------------------------------- |
| **Тимлид/Архитектор**  | **Maintainer**  | Может управлять ветками (`main`, `develop`), настраивать CI/CD, мержить MR в `main`. |
| **Бэкенд-разработчик** | **Developer**   | Может создавать `feature/*` ветки, пушить в них, создавать Merge Request в `develop`. |
| **Фронтенд-разработчик** | **Developer**   | Аналогично бэкенд-разработчику.                                             |
| **Тестировщик (QA)**   | **Reporter**    | Может просматривать код, создавать issue по багам, но не может пушить код.  |
| **Менеджер проекта**   | **Reporter**    | Может просматривать прогресс, создавать issue на новые задачи.              |

**Шаг 3: Настройка Protected Branches**

Это ключевой механизм контроля.

1.  Перейдите в **Settings > Repository** и раскройте раздел **Protected Branches**.
2.  Защитите ветку `main`:
    *   **Allowed to push:** `Maintainers`
    *   **Allowed to merge:** `Maintainers` (Только тимлиды могут вливать код в продакшен)
    *   **Allowed to push and merge:** `No one`
3.  Защитите ветку `develop`:
    *   **Allowed to push:** `No one` (Никто не может пушить напрямую!)
    *   **Allowed to merge:** `Developers + Maintainers` (Разработчики могут мержить свои MR после ревью)
    *   **Разрешить создание палки для всех с правом на пуш:** `true`

**Итог:** Прямой пуш в `main` и `develop` запрещен для всех. Попадание кода возможно только через **Merge Request (MR)**.

---

#### **6. Настройка рабочего процесса (Workflow) с Code Review**

**Процесс для разработки новой функции:**

1.  **Создание ветки:** Разработчик создает ветку от `develop`.
    ```bash
    git checkout develop
    git pull origin develop
    git checkout -b feature/user-authentication
    ```
2.  **Разработка и коммиты:** Разработчик пушит код в свою ветку.
    ```bash
    git add .
    git commit -m "feat: add JWT token authentication"
    git push origin feature/user-authentication
    ```
3.  **Создание Merge Request (MR):**
    *   В GitLab разработчик создает MR из `feature/user-authentication` в `develop`.
    *   В описании MR использует шаблон: что сделано, как тестировать.
    *   **Назначает Reviewer:** одного или нескольких старших разработчиков или тимлида.
4.  **Code Review:**
    *   Ревьювер проверяет код, оставляет комментарии.
    *   Запускается **CI/CD пайплайн** (сборка, тесты), который должен быть "зеленым".
    *   Разработчик вносит правки по результатам ревью, пушит их в свою ветку.
5.  **Слияние (Merge):**
    *   После одобрения ревьювера и успешного прохождения CI/CD, разработчик (или ревьювер) нажимает "Merge".
    *   **Важно:** Выбрать опцию **"Delete source branch"** для очистки репозитория.
    *   Код попадает в `develop`.

**Процесс для горячего исправления (Hotfix):**

1.  Создается ветка `hotfix/...` от `main`.
2.  MR создается сразу в `main` (и затем в `develop`).
3.  Ревью и мерж выполняет только **Maintainer**.

---

#### **7. Дополнительные настройки для повышения качества кода**

*   **Merge Checks (Настройки MR):** В настройках проекта можно обязать:
    *   "Pipelines must succeed" – Запретить мерж, если упали тесты в CI/CD.
    *   "All discussions must be resolved" – Запретить мерж, пока все комментарии ревью не закрыты.
*   **Шаблоны для Issue и Merge Request:** Создать файлы `.gitlab/issue_templates/` и `.gitlab/merge_request_templates/` для стандартизации описаний.
*   **Webhooks:** Настроить интеграцию с внешними системами (например, Slack для уведомлений о новых MR).

---

#### **Заключение**

В результате проделанной работы мы развернули отказоустойчивую и безопасную систему контроля версий на базе GitLab. Ключевые достижения:

1.  **Установлен и настроен** сервер GitLab.
2.  **Внедрена модель ветвления** GitFlow, которая четко разделяет этапы разработки.
3.  **Настроено разграничение ролей** на основе должностных обязанностей, что минимизирует риски человеческого фактора.
4.  **Внедрен обязательный процесс Code Review** через Merge Requests, что повышает качество кода и способствует обмену знаниями в команде.
5.  **Защищены ключевые ветки** (`main`, `develop`), что гарантирует стабильность основной кодовой базы.

Данная конфигурация создает профессиональную основу для командной разработки сложного проекта, такого как интернет-магазин, и является залогом управляемого и предсказуемого процесса разработки.
