# **–ü–ú05. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞**

## **1. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

### **1.1. –ú–∞—Ç—Ä–∏—Ü–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**

```yaml
# integration_test_matrix.yml
integration_points:
  internal_modules:
    - "auth ‚Üí products"
    - "products ‚Üí orders" 
    - "orders ‚Üí payments"
    - "payments ‚Üí notifications"
    - "users ‚Üí orders"
    - "cart ‚Üí orders"

  external_services:
    payment_gateways:
      - "stripe"
      - "cloudpayments"
      - "yookassa"
    shipping_services:
      - "cdek"
      - "boxberry" 
      - "russian_post"
    email_services:
      - "sendgrid"
      - "mailgun"
      - "smtp"
    sms_services:
      - "twilio"
      - "sms_ru"

  data_flows:
    - "user_registration_flow"
    - "product_purchase_flow"
    - "order_fulfillment_flow"
    - "inventory_sync_flow"
    - "analytics_data_flow"
```

---

## **2. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

### **2.1. Docker Compose –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

```yaml
# docker-compose.integration.yml
version: '3.8'

services:
  # –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: ecommerce_integration
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d ecommerce_integration"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://test_user:test_password@postgres:5432/ecommerce_integration
      REDIS_URL: redis://redis:6379/0
      DJANGO_SETTINGS_MODULE: config.settings.integration
      DEBUG: "False"
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./integration_reports:/app/integration_reports

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://test_user:test_password@postgres:5432/ecommerce_integration
      REDIS_URL: redis://redis:6379/0
      DJANGO_SETTINGS_MODULE: config.settings.integration
    command: celery -A config worker --loglevel=info --concurrency=2
    depends_on:
      - postgres
      - redis
      - app

  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://test_user:test_password@postgres:5432/ecommerce_integration
      REDIS_URL: redis://redis:6379/0
      DJANGO_SETTINGS_MODULE: config.settings.integration
    command: celery -A config beat --loglevel=info
    depends_on:
      - postgres
      - redis
      - app

  # Mock —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
  mock-payment-service:
    image: mockserver/mockserver
    ports:
      - "1080:1080"
    command: -serverPort 1080 -logLevel INFO

  mock-shipping-service:
    image: mockserver/mockserver
    ports:
      - "1081:1080"
    command: -serverPort 1080 -logLevel INFO

  mock-email-service:
    image: mockserver/mockserver
    ports:
      - "1082:1080"
    command: -serverPort 1080 -logLevel INFO

  # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  integration-tester:
    build:
      context: .
      dockerfile: Dockerfile.integration-test
    environment:
      APP_URL: http://app:8000
      PAYMENT_MOCK_URL: http://mock-payment-service:1080
      SHIPPING_MOCK_URL: http://mock-shipping-service:1080
      EMAIL_MOCK_URL: http://mock-email-service:1080
    depends_on:
      - app
      - mock-payment-service
      - mock-shipping-service
      - mock-email-service
    volumes:
      - ./integration_reports:/app/integration_reports
    command: python scripts/integration_test_runner.py
```

### **2.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Django –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

```python
# config/settings/integration.py
from .base import *

DEBUG = False

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'ecommerce_integration',
        'USER': 'test_user',
        'PASSWORD': 'test_password',
        'HOST': os.getenv('POSTGRES_HOST', 'localhost'),
        'PORT': '5432',
    }
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (mock)
PAYMENT_SERVICE_URL = os.getenv('PAYMENT_MOCK_URL', 'http://localhost:1080')
SHIPPING_SERVICE_URL = os.getenv('SHIPPING_MOCK_URL', 'http://localhost:1081')
EMAIL_SERVICE_URL = os.getenv('EMAIL_MOCK_URL', 'http://localhost:1082')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Celery –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
CELERY_BROKER_URL = 'redis://redis:6379/0'
CELERY_RESULT_BACKEND = 'redis://redis:6379/0'

# –û—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã
PAYMENT_SERVICE_ENABLED = True
SHIPPING_SERVICE_ENABLED = True
EMAIL_SERVICE_ENABLED = True

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'DEBUG',
            'class': 'logging.FileHandler',
            'filename': '/app/logs/integration_test.log',
        },
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'console'],
            'level': 'INFO',
            'propagate': True,
        },
        'ecommerce': {
            'handlers': ['file', 'console'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}
```

---

## **3. –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

### **3.1. –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**

```python
# tests/integration/test_base.py
import pytest
import requests
from django.test import TestCase
from django.conf import settings
from datetime import datetime
import json

class IntegrationTestBase(TestCase):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"""
    
    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        cls.base_url = "http://localhost:8000"
        cls.session = requests.Session()
        cls.test_start_time = datetime.now()
        
    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.test_data = {}
        self._setup_mock_services()
        
    def _setup_mock_services(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock —Å–µ—Ä–≤–∏—Å–æ–≤"""
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
        self._setup_payment_mock()
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        self._setup_shipping_mock()
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock email —Å–µ—Ä–≤–∏—Å–∞
        self._setup_email_mock()
    
    def _setup_payment_mock(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞"""
        payment_mock_url = f"{settings.PAYMENT_SERVICE_URL}/mockserver/expectation"
        
        # Mock –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        create_payment_expectation = {
            "httpRequest": {
                "method": "POST",
                "path": "/api/v1/payments"
            },
            "httpResponse": {
                "statusCode": 201,
                "body": json.dumps({
                    "id": "pay_test_123",
                    "status": "pending",
                    "confirmation_url": "https://payment-test.com/confirm"
                }),
                "headers": {
                    "Content-Type": ["application/json"]
                }
            }
        }
        
        response = requests.put(payment_mock_url, json=create_payment_expectation)
        assert response.status_code == 201, "Failed to setup payment mock"
    
    def _make_authenticated_request(self, method, endpoint, **kwargs):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
        headers = kwargs.get('headers', {})
        if hasattr(self, 'auth_token'):
            headers['Authorization'] = f'Bearer {self.auth_token}'
        kwargs['headers'] = headers
        
        url = f"{self.base_url}{endpoint}"
        response = self.session.request(method, url, **kwargs)
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print(f"{method} {endpoint} -> {response.status_code}")
        
        return response
    
    def create_test_user(self, email="test@example.com", password="testpass123"):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_data = {
            "email": email,
            "password": password,
            "first_name": "Test",
            "last_name": "User"
        }
        
        response = self._make_authenticated_request(
            'POST', '/api/auth/register/', 
            json=user_data
        )
        
        if response.status_code == 201:
            self.test_data['user'] = response.json()
            return response.json()
        else:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ª–æ–≥–∏–Ω–∏–º—Å—è
            login_response = self._make_authenticated_request(
                'POST', '/api/auth/login/',
                json={"email": email, "password": password}
            )
            if login_response.status_code == 200:
                self.auth_token = login_response.json()['access']
                self.test_data['user'] = login_response.json()['user']
                return self.test_data['user']
        
        raise Exception(f"Failed to create test user: {response.text}")
    
    def wait_for_async_task(self, task_id, timeout=30):
        """–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏"""
        import time
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            response = self._make_authenticated_request(
                'GET', f'/api/tasks/{task_id}/status/'
            )
            
            if response.status_code == 200:
                status = response.json()['status']
                if status in ['SUCCESS', 'FAILURE']:
                    return status
            
            time.sleep(1)
        
        raise TimeoutError(f"Task {task_id} did not complete in {timeout} seconds")
```

### **3.2. Mock —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π**

```python
# tests/integration/mocks/external_services.py
import json
import requests
from datetime import datetime

class PaymentServiceMock:
    """Mock –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞"""
    
    def __init__(self, base_url):
        self.base_url = base_url
        self.setup_expectations()
    
    def setup_expectations(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∂–∏–¥–∞–Ω–∏–π –¥–ª—è mock —Å–µ—Ä–≤–∏—Å–∞"""
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        self._setup_expectation(
            method="POST",
            path="/api/v1/payments",
            response={
                "statusCode": 201,
                "body": json.dumps({
                    "id": f"pay_mock_{datetime.now().timestamp()}",
                    "status": "pending",
                    "confirmation_url": f"{self.base_url}/confirm/payment",
                    "amount": 1000,
                    "currency": "RUB"
                })
            }
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
        self._setup_expectation(
            method="GET",
            path="/api/v1/payments/.+",
            response={
                "statusCode": 200,
                "body": json.dumps({
                    "id": "pay_mock_123",
                    "status": "succeeded",
                    "paid": True,
                    "amount": 1000,
                    "currency": "RUB"
                })
            }
        )
        
        # –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
        self._setup_expectation(
            method="POST",
            path="/api/v1/refunds",
            response={
                "statusCode": 201,
                "body": json.dumps({
                    "id": f"refund_mock_{datetime.now().timestamp()}",
                    "status": "pending",
                    "amount": 1000
                })
            }
        )
    
    def _setup_expectation(self, method, path, response):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è mock —Å–µ—Ä–≤–∏—Å–∞"""
        expectation = {
            "httpRequest": {
                "method": method,
                "path": path
            },
            "httpResponse": response
        }
        
        response = requests.put(
            f"{self.base_url}/mockserver/expectation",
            json=expectation
        )
        assert response.status_code == 201, f"Failed to setup expectation: {response.text}"

class ShippingServiceMock:
    """Mock –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏"""
    
    def __init__(self, base_url):
        self.base_url = base_url
        self.setup_expectations()
    
    def setup_expectations(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∂–∏–¥–∞–Ω–∏–π –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏"""
        
        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
        self._setup_expectation(
            method="POST",
            path="/api/v1/shipping/calculate",
            response={
                "statusCode": 200,
                "body": json.dumps({
                    "cost": 250.00,
                    "delivery_days": 3,
                    "service": "standard"
                })
            }
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        self._setup_expectation(
            method="POST",
            path="/api/v1/shipping/orders",
            response={
                "statusCode": 201,
                "body": json.dumps({
                    "id": f"ship_mock_{datetime.now().timestamp()}",
                    "tracking_number": "TRACK123456",
                    "status": "created"
                })
            }
        )
```

---

## **4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –º–æ–¥—É–ª–µ–π**

### **4.1. –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–æ–¥—É–ª–µ–π**

```python
# tests/integration/test_user_flows.py
import pytest
from .test_base import IntegrationTestBase
from datetime import datetime

class TestUserRegistrationFlow(IntegrationTestBase):
    """–¢–µ—Å—Ç—ã –ø–æ—Ç–æ–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    def test_complete_user_registration_flow(self):
        """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–æ—Ç–æ–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_data = {
            "email": f"test_{datetime.now().timestamp()}@example.com",
            "password": "TestPassword123!",
            "first_name": "Integration",
            "last_name": "Test",
            "phone": "+79123456789"
        }
        
        response = self._make_authenticated_request(
            'POST', '/api/auth/register/',
            json=user_data
        )
        
        assert response.status_code == 201
        user_response = response.json()
        assert 'user' in user_response
        assert 'access_token' in user_response
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        self.auth_token = user_response['access_token']
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email (mock)
        verification_response = self._make_authenticated_request(
            'POST', '/api/auth/verify-email/',
            json={"token": "mock_verification_token"}
        )
        assert verification_response.status_code in [200, 400]  # –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
        
        # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        profile_response = self._make_authenticated_request(
            'GET', '/api/users/profile/'
        )
        assert profile_response.status_code == 200
        profile_data = profile_response.json()
        assert profile_data['email'] == user_data['email']
        assert profile_data['first_name'] == user_data['first_name']
        
        # 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        update_data = {
            "first_name": "Updated",
            "last_name": "Name",
            "phone": "+79998887766"
        }
        
        update_response = self._make_authenticated_request(
            'PUT', '/api/users/profile/',
            json=update_data
        )
        assert update_response.status_code == 200
        updated_profile = update_response.json()
        assert updated_profile['first_name'] == "Updated"
        
        # 5. –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
        password_change_data = {
            "old_password": user_data['password'],
            "new_password": "NewPassword123!"
        }
        
        password_response = self._make_authenticated_request(
            'POST', '/api/auth/change-password/',
            json=password_change_data
        )
        assert password_response.status_code == 200
        
        print("‚úÖ User registration flow completed successfully")

class TestUserOrderFlow(IntegrationTestBase):
    """–¢–µ—Å—Ç—ã –ø–æ—Ç–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    def setUp(self):
        super().setUp()
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∞
        self.user = self.create_test_user()
        self.products = self._create_test_products()
    
    def _create_test_products(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
        products = []
        
        # –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        for i in range(3):
            product_data = {
                "name": f"Integration Test Product {i}",
                "description": f"Test product for integration testing {i}",
                "price": 100.00 + (i * 50),
                "sku": f"INT_TEST_{i}_{datetime.now().timestamp()}",
                "quantity": 10
            }
            
            response = self._make_authenticated_request(
                'POST', '/api/products/',
                json=product_data
            )
            
            if response.status_code == 201:
                products.append(response.json())
        
        return products
    
    def test_complete_order_flow(self):
        """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞"""
        # 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É
        cart_items = []
        for product in self.products:
            cart_item = {
                "product_id": product['id'],
                "quantity": 2
            }
            
            response = self._make_authenticated_request(
                'POST', '/api/cart/items/',
                json=cart_item
            )
            assert response.status_code == 201
            cart_items.append(response.json())
        
        # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
        cart_response = self._make_authenticated_request('GET', '/api/cart/')
        assert cart_response.status_code == 200
        cart_data = cart_response.json()
        assert len(cart_data['items']) == len(self.products)
        
        # 3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        order_data = {
            "shipping_address": {
                "first_name": "Test",
                "last_name": "User",
                "street": "Test Street 123",
                "city": "Moscow",
                "postal_code": "123456",
                "country": "RU"
            },
            "billing_address": {
                "first_name": "Test",
                "last_name": "User", 
                "street": "Test Street 123",
                "city": "Moscow",
                "postal_code": "123456",
                "country": "RU"
            },
            "payment_method": "card",
            "shipping_method": "standard"
        }
        
        order_response = self._make_authenticated_request(
            'POST', '/api/orders/',
            json=order_data
        )
        assert order_response.status_code == 201
        order = order_response.json()
        assert order['status'] == 'pending'
        
        # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
        payment_data = {
            "order_id": order['id'],
            "payment_method": "card",
            "payment_token": "mock_payment_token_123"
        }
        
        payment_response = self._make_authenticated_request(
            'POST', '/api/payments/process/',
            json=payment_data
        )
        assert payment_response.status_code == 200
        payment = payment_response.json()
        assert payment['status'] in ['pending', 'succeeded']
        
        # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        order_status_response = self._make_authenticated_request(
            'GET', f"/api/orders/{order['id']}/"
        )
        assert order_status_response.status_code == 200
        updated_order = order_status_response.json()
        assert updated_order['status'] in ['confirmed', 'processing']
        
        print("‚úÖ Order flow completed successfully")
```

### **4.2. –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã**

```python
# tests/integration/test_payment_integration.py
import pytest
from .test_base import IntegrationTestBase

class TestPaymentIntegration(IntegrationTestBase):
    """–¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏"""
    
    def test_payment_processing_flow(self):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
        order = self._create_test_order()
        
        # –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø–ª–∞—Ç–µ–∂
        payment_data = {
            "order_id": order['id'],
            "amount": order['total'],
            "currency": "RUB",
            "payment_method": "card",
            "return_url": "http://localhost:8000/payment/return"
        }
        
        payment_response = self._make_authenticated_request(
            'POST', '/api/payments/create/',
            json=payment_data
        )
        assert payment_response.status_code == 201
        payment = payment_response.json()
        assert 'id' in payment
        assert 'confirmation_url' in payment
        
        # –≠–º—É–ª–∏—Ä—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        confirm_data = {
            "payment_id": payment['id'],
            "confirmation_token": "mock_confirmation_token"
        }
        
        confirm_response = self._make_authenticated_request(
            'POST', '/api/payments/confirm/',
            json=confirm_data
        )
        assert confirm_response.status_code == 200
        confirmed_payment = confirm_response.json()
        assert confirmed_payment['status'] == 'succeeded'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        order_response = self._make_authenticated_request(
            'GET', f"/api/orders/{order['id']}/"
        )
        updated_order = order_response.json()
        assert updated_order['payment_status'] == 'paid'
        assert updated_order['status'] == 'confirmed'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        # (–ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ mock email —Å–µ—Ä–≤–∏—Å)
        self._verify_notification_sent('order_confirmation', order['id'])
    
    def test_payment_refund_flow(self):
        """–¢–µ—Å—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞"""
        # –°–æ–∑–¥–∞–µ–º –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑
        order = self._create_paid_order()
        
        # –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –≤–æ–∑–≤—Ä–∞—Ç
        refund_data = {
            "order_id": order['id'],
            "amount": order['total'],
            "reason": "customer_request"
        }
        
        refund_response = self._make_authenticated_request(
            'POST', '/api/payments/refund/',
            json=refund_data
        )
        assert refund_response.status_code == 201
        refund = refund_response.json()
        assert refund['status'] == 'pending'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        order_response = self._make_authenticated_request(
            'GET', f"/api/orders/{order['id']}/"
        )
        updated_order = order_response.json()
        assert updated_order['payment_status'] == 'refunded'
        assert updated_order['status'] == 'refunded'
    
    def _create_test_order(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞"""
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–¥—É–∫—Ç—ã
        self.create_test_user()
        products = self._create_test_products(count=2)
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
        order_data = {
            "items": [
                {"product_id": products[0]['id'], "quantity": 1},
                {"product_id": products[1]['id'], "quantity": 2}
            ],
            "shipping_address": {
                "first_name": "Test",
                "last_name": "User",
                "street": "Test Street 123",
                "city": "Moscow",
                "postal_code": "123456"
            }
        }
        
        response = self._make_authenticated_request(
            'POST', '/api/orders/',
            json=order_data
        )
        assert response.status_code == 201
        return response.json()
    
    def _verify_notification_sent(self, notification_type, order_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ mock —Å–µ—Ä–≤–∏—Å"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ mock email —Å–µ—Ä–≤–∏—Å
        verify_url = f"{settings.EMAIL_SERVICE_URL}/mockserver/verify"
        
        verification_request = {
            "httpRequest": {
                "method": "POST",
                "path": "/api/v1/emails/send"
            },
            "times": {
                "atLeast": 1
            }
        }
        
        response = requests.put(verify_url, json=verification_request)
        assert response.status_code == 202, "Notification was not sent"
```

### **4.3. –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏**

```python
# tests/integration/test_external_services.py
import pytest
import requests
from .test_base import IntegrationTestBase

class TestExternalServicesIntegration(IntegrationTestBase):
    """–¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏"""
    
    def test_shipping_service_integration(self):
        """–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–∏—Å–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
        order = self._create_test_order()
        
        # –ó–∞–ø—Ä–æ—Å —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
        shipping_calc_data = {
            "order_id": order['id'],
            "destination": {
                "city": "Moscow",
                "postal_code": "123456"
            },
            "packages": [
                {
                    "weight": 1.5,
                    "dimensions": {"length": 30, "width": 20, "height": 10}
                }
            ]
        }
        
        shipping_response = self._make_authenticated_request(
            'POST', '/api/shipping/calculate/',
            json=shipping_calc_data
        )
        assert shipping_response.status_code == 200
        shipping_quote = shipping_response.json()
        assert 'cost' in shipping_quote
        assert 'delivery_days' in shipping_quote
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        shipping_order_data = {
            "order_id": order['id'],
            "service": "standard",
            "recipient": {
                "name": "Test User",
                "phone": "+79123456789",
                "address": shipping_calc_data['destination']
            }
        }
        
        create_shipping_response = self._make_authenticated_request(
            'POST', '/api/shipping/create/',
            json=shipping_order_data
        )
        assert create_shipping_response.status_code == 201
        shipping_order = create_shipping_response.json()
        assert 'tracking_number' in shipping_order
        assert 'id' in shipping_order
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        tracking_response = self._make_authenticated_request(
            'GET', f"/api/shipping/tracking/{shipping_order['id']}/"
        )
        assert tracking_response.status_code == 200
        tracking_info = tracking_response.json()
        assert 'status' in tracking_info
    
    def test_inventory_sync_integration(self):
        """–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç
        product_data = {
            "name": "Inventory Sync Test Product",
            "description": "Product for inventory sync testing",
            "price": 150.00,
            "sku": "INV_SYNC_TEST",
            "quantity": 50
        }
        
        product_response = self._make_authenticated_request(
            'POST', '/api/products/',
            json=product_data
        )
        product = product_response.json()
        
        # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂—É (—É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
        sale_data = {
            "product_id": product['id'],
            "quantity": 5
        }
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å —á–µ—Ä–µ–∑ API
        inventory_response = self._make_authenticated_request(
            'PUT', f"/api/products/{product['id']}/inventory/",
            json=sale_data
        )
        assert inventory_response.status_code == 200
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        product_check_response = self._make_authenticated_request(
            'GET', f"/api/products/{product['id']}/"
        )
        updated_product = product_check_response.json()
        assert updated_product['quantity'] == 45
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
        # (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ERP/WMS)
        self._verify_external_inventory_sync(product['id'])
    
    def test_analytics_integration(self):
        """–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
        events = [
            {
                "type": "page_view",
                "page": "/products/1",
                "user_agent": "integration-test"
            },
            {
                "type": "add_to_cart", 
                "product_id": "test_product_1",
                "quantity": 2
            },
            {
                "type": "purchase",
                "order_id": "test_order_123",
                "amount": 200.00
            }
        ]
        
        for event in events:
            analytics_response = self._make_authenticated_request(
                'POST', '/api/analytics/track/',
                json=event
            )
            assert analytics_response.status_code == 200
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        stats_response = self._make_authenticated_request(
            'GET', '/api/analytics/stats/'
        )
        assert stats_response.status_code == 200
        stats = stats_response.json()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
        assert 'page_views' in stats
        assert 'conversion_rate' in stats
```

---

## **5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤**

### **5.1. –¢–µ—Å—Ç—ã Celery –∑–∞–¥–∞—á –∏ —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤**

```python
# tests/integration/test_async_processes.py
import pytest
import time
from celery.result import AsyncResult
from .test_base import IntegrationTestBase

class TestAsyncProcessesIntegration(IntegrationTestBase):
    """–¢–µ—Å—Ç—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ Celery –∑–∞–¥–∞—á"""
    
    def test_order_processing_workflow(self):
        """–¢–µ—Å—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
        order = self._create_test_order()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞
        process_response = self._make_authenticated_request(
            'POST', f"/api/orders/{order['id']}/process/"
        )
        assert process_response.status_code == 202
        process_data = process_response.json()
        assert 'task_id' in process_data
        
        # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        task_status = self.wait_for_async_task(process_data['task_id'])
        assert task_status == 'SUCCESS'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏
        order_response = self._make_authenticated_request(
            'GET', f"/api/orders/{order['id']}/"
        )
        processed_order = order_response.json()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
        assert processed_order['status'] == 'processing'
        assert processed_order['inventory_reserved'] == True
        assert processed_order['payment_processed'] == True
        assert processed_order['shipping_created'] == True
    
    def test_inventory_management_workflow(self):
        """–¢–µ—Å—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        products = self._create_test_products(count=3)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        sync_response = self._make_authenticated_request(
            'POST', '/api/inventory/sync/'
        )
        assert sync_response.status_code == 202
        sync_data = sync_response.json()
        
        # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        task_status = self.wait_for_async_task(sync_data['task_id'])
        assert task_status == 'SUCCESS'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        inventory_response = self._make_authenticated_request(
            'GET', '/api/inventory/status/'
        )
        inventory_status = inventory_response.json()
        assert inventory_status['last_sync'] is not None
        assert inventory_status['products_synced'] >= len(products)
    
    def test_notification_system_workflow(self):
        """–¢–µ—Å—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
        order = self._create_test_order()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        notification_data = {
            "order_id": order['id'],
            "notification_type": "order_created"
        }
        
        notify_response = self._make_authenticated_request(
            'POST', '/api/notifications/send/',
            json=notification_data
        )
        assert notify_response.status_code == 202
        notify_data = notify_response.json()
        
        # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        task_status = self.wait_for_async_task(notify_data['task_id'])
        assert task_status == 'SUCCESS'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
        notifications_response = self._make_authenticated_request(
            'GET', f"/api/notifications/order/{order['id']}/"
        )
        notifications = notifications_response.json()
        assert len(notifications) > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ email –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        email_sent = any(n['type'] == 'email' for n in notifications)
        assert email_sent == True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ mock, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ –∫ email —Å–µ—Ä–≤–∏—Å—É
        self._verify_email_service_called()
    
    def _verify_email_service_called(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–æ–≤ email —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ mock"""
        verify_url = f"{settings.EMAIL_SERVICE_URL}/mockserver/verify"
        
        verification_request = {
            "httpRequest": {
                "method": "POST",
                "path": "/api/v1/emails/send"
            },
            "times": {
                "atLeast": 1
            }
        }
        
        response = requests.put(verify_url, json=verification_request)
        assert response.status_code == 202, "Email service was not called"
```

---

## **6. –ó–∞–ø—É—Å–∫ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**

### **6.1. –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**

```python
#!/usr/bin/env python3
# scripts/integration_test_runner.py
import os
import sys
import subprocess
import json
import time
import requests
from datetime import datetime

class IntegrationTestRunner:
    """–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"""
    
    def __init__(self):
        self.results = {}
        self.start_time = datetime.now()
        self.base_url = "http://localhost:8000"
    
    def wait_for_services(self, timeout=300):
        """–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤"""
        print("‚è≥ Waiting for services to be ready...")
        
        start_time = time.time()
        services_ready = False
        
        while time.time() - start_time < timeout:
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                response = requests.get(f"{self.base_url}/health/", timeout=5)
                if response.status_code == 200:
                    health_data = response.json()
                    if all(health_data.values()):
                        services_ready = True
                        break
            except requests.exceptions.RequestException:
                pass
            
            time.sleep(5)
        
        if not services_ready:
            raise Exception("Services did not become ready in time")
        
        print("‚úÖ All services are ready")
    
    def run_integration_tests(self):
        """–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"""
        print("üöÄ Starting integration tests...")
        
        # –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
        self.wait_for_services()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        test_categories = [
            "tests.integration.test_user_flows",
            "tests.integration.test_payment_integration", 
            "tests.integration.test_external_services",
            "tests.integration.test_async_processes"
        ]
        
        for test_category in test_categories:
            print(f"\nüìã Running {test_category}...")
            
            try:
                result = subprocess.run([
                    "python", "manage.py", "test",
                    test_category,
                    "--verbosity=2",
                    "--no-input",
                    f"--junitxml=integration_reports/{test_category.split('.')[-1]}_results.xml"
                ], capture_output=True, text=True, timeout=600)
                
                self.results[test_category] = {
                    "exit_code": result.returncode,
                    "success": result.returncode == 0,
                    "stdout": result.stdout,
                    "stderr": result.stderr
                }
                
                if result.returncode == 0:
                    print(f"‚úÖ {test_category}: PASSED")
                else:
                    print(f"‚ùå {test_category}: FAILED")
                    
            except subprocess.TimeoutExpired:
                self.results[test_category] = {
                    "exit_code": -1,
                    "success": False,
                    "error": "Timeout expired"
                }
                print(f"‚è∞ {test_category}: TIMEOUT")
        
        self.generate_integration_report()
        return self.results
    
    def generate_integration_report(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        end_time = datetime.now()
        duration = (end_time - self.start_time).total_seconds()
        
        report = {
            "integration_test_report": {
                "start_time": self.start_time.isoformat(),
                "end_time": end_time.isoformat(),
                "duration_seconds": duration,
                "total_test_categories": len(self.results),
                "passed_categories": sum(1 for r in self.results.values() if r["success"]),
                "failed_categories": sum(1 for r in self.results.values() if not r["success"]),
                "success_rate": (sum(1 for r in self.results.values() if r["success"]) / len(self.results)) * 100
            },
            "test_results": self.results
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç
        os.makedirs("integration_reports", exist_ok=True)
        report_file = f"integration_reports/integration_test_{self.start_time.strftime('%Y%m%d_%H%M%S')}.json"
        
        with open(report_file, 'w') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        # –í—ã–≤–æ–¥–∏–º —Å–≤–æ–¥–∫—É
        print("\n" + "="*60)
        print("INTEGRATION TESTING SUMMARY")
        print("="*60)
        print(f"Duration: {duration:.2f} seconds")
        print(f"Success Rate: {report['integration_test_report']['success_rate']:.1f}%")
        print(f"Passed: {report['integration_test_report']['passed_categories']}")
        print(f"Failed: {report['integration_test_report']['failed_categories']}")
        print("="*60)
        
        return report

if __name__ == "__main__":
    runner = IntegrationTestRunner()
    
    try:
        results = runner.run_integration_tests()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        success_rate = results['integration_test_report']['success_rate']
        sys.exit(0 if success_rate >= 80 else 1)
        
    except Exception as e:
        print(f"‚ùå Integration testing failed: {str(e)}")
        sys.exit(1)
```

### **6.2. GitHub Actions workflow –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

```yaml
# .github/workflows/integration-tests.yml
name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 1 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 1:00

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: ecommerce_integration
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      mock-payment:
        image: mockserver/mockserver
        ports:
          - 1080:1080
        
      mock-shipping:
        image: mockserver/mockserver  
        ports:
          - 1081:1080
          
      mock-email:
        image: mockserver/mockserver
        ports:
          - 1082:1080

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Setup test database
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/ecommerce_integration
        DJANGO_SETTINGS_MODULE: config.settings.integration
      run: |
        python manage.py migrate
        python manage.py collectstatic --noinput
    
    - name: Start application
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/ecommerce_integration
        REDIS_URL: redis://localhost:6379/0
        DJANGO_SETTINGS_MODULE: config.settings.integration
        PAYMENT_MOCK_URL: http://localhost:1080
        SHIPPING_MOCK_URL: http://localhost:1081
        EMAIL_MOCK_URL: http://localhost:1082
      run: |
        python manage.py runserver 8000 &
        celery -A config worker --loglevel=info &
        celery -A config beat --loglevel=info &
    
    - name: Wait for application
      run: |
        timeout 300 bash -c 'until curl -f http://localhost:8000/health/ >/dev/null 2>&1; do
          sleep 5
        done'
    
    - name: Run integration tests
      env:
        APP_URL: http://localhost:8000
        PAYMENT_MOCK_URL: http://localhost:1080
        SHIPPING_MOCK_URL: http://localhost:1081
        EMAIL_MOCK_URL: http://localhost:1082
        DJANGO_SETTINGS_MODULE: config.settings.integration
      run: |
        python scripts/integration_test_runner.py
    
    - name: Upload integration reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-reports
        path: integration_reports/
        retention-days: 30
```

–î–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

1. **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
2. **–ò–∑–æ–ª—è—Ü–∏—é —Ç–µ—Å—Ç–æ–≤** —á–µ—Ä–µ–∑ mock —Å–µ—Ä–≤–∏—Å—ã
3. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é** –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏
4. **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –≤ CI/CD
5. **–î–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –ø—Ä–æ–±–ª–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
